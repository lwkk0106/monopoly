<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=900, initial-scale=1.0">
  <title>å¤§å¯Œç¿</title>
  <style>
    body {
      font-family: "DFKai-SB", "æ¨™æ¥·é«”", DFKai-SB, serif;
      background: url('https://raw.githubusercontent.com/lwkk0106/game-arts/main/background.png') center center/cover no-repeat, linear-gradient(120deg, #f8f8f8 0%, #e0e0e0 60%, #bdbdbd 100%);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      color: #222;
    }
    h1 {
      margin-top: 18px;
      font-size: 2.2rem;
      letter-spacing: 2px;
      text-shadow: 2px 2px 8px #fff;
      text-align: center;
    }
    #main-row {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100vw;
      max-width: 1200px;
      margin: 0 auto;
    }
    #board-area {
      position: relative;
      width: 95vw;
      max-width: 900px;
      margin: 0 auto 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #board {
      display: grid;
      grid-template-rows: repeat(5, minmax(0, 1fr));
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: 2px;
      background: rgba(0,0,0,0.12);
      border: 3px solid #222;
      border-radius: 18px;
      box-shadow: 0 8px 32px #8888;
      position: relative;
      z-index: 1;
      width: 100%;
      aspect-ratio: 12/5;
      min-width: 320px;
      max-width: 900px;
      min-height: 180px;
      max-height: 400px;
      margin-bottom: 0;
    }
    .cell {
      background: #fff;
      border: 2px solid #222;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      font-size: 1.1rem;
      position: relative;
      min-width: 0;
      min-height: 0;
      box-sizing: border-box;
      padding: 2px 0 0 0;
      border-radius: 12px;
      box-shadow: 0 2px 8px #bbb8;
      transition: background 0.3s;
      overflow: visible;
      opacity: 0.98;
    }
    .cell.start { background: linear-gradient(135deg, #e2fdff 80%, #bcfbff 100%); border: 2px solid #222; }
    .cell.jail { background: linear-gradient(135deg, #fcdbac 80%, #ffbc57 100%); border: 2px solid #222; }
    .cell.go-jail { background: linear-gradient(135deg, #fffeb4 80%, #fff9bd 100%); border: 2px solid #222; color: #222;}
    .cell.question { background: linear-gradient(135deg, #fce4ec 60%, #f8bbd0 100%); border: 2px solid #222;}
    .cell.chance { background: linear-gradient(135deg, #e8f5e9 60%, #b2dfdb 100%); border: 2px solid #222;}
    .cell.fate { background: linear-gradient(135deg, #fde5ff 60%, #efb1fe 100%); border: 2px solid #222;}
    .cell.normal { background: linear-gradient(135deg, #fff 80%, #e5e5e5 100%); border: 2px solid #222;}
    .cell .emoji {
      font-size: 1.3em;
      margin-bottom: 4px;
      text-shadow: 1px 1px 4px #fff8;
      filter: grayscale(0.5) contrast(0.8);
    }
    .cell .cell-label {
      font-size: 1.1em;
      margin-bottom: 4px;
      text-align: center;
      word-break: break-all;
      color: #000000;
      letter-spacing: 1px;
      text-shadow: 0 1px 0 #fff;
    }
    .cell .players {
      position: absolute;
      bottom: 2px; left: 2px; right: 2px;
      display: flex; flex-wrap: wrap;
      justify-content: center;
      gap: 2px;
      z-index: 2;
    }
    .cell .player-avatar-onboard {
      width: 2.1em; height: 2.1em;
      border-radius: 50%;
      border: 1px solid #fff;
      box-shadow: 0 0 0 2px #222, 0 2px 8px #8888;
      background: #fff;
      object-fit: cover;
      margin: 0 1px;
    }
    #bottom-bar {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: flex-start;
      width: 100%;
      max-width: 900px;
      margin: 18px auto 0 auto;
      gap: 32px;
    }
    #players-bar {
      display: flex;
      flex-direction: row;
      justify-content: flex-start;
      align-items: center;
      gap: 18px;
      min-width: 180px;
      max-width: 900px;
      background: none;
      border-radius: 0;
      box-shadow: none;
      padding: 0;
    }
    .player-card {
      display: flex;
      flex-direction: row;
      align-items: center;
      position: relative;
      min-width: 120px;
      padding: 0 8px;
    }
    .player-avatar-info {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-right: 8px;
    }
    .player-avatar {
      width: 2.5em; height: 2.5em;
      border-radius: 50%;
      border: 3px solid #eee;
      box-shadow: 0 0 0 0 #fff, 0 2px 8px #8888;
      background: #fff;
      object-fit: cover;
      margin-bottom: 2px;
      transition: box-shadow 0.3s;
    }
    .player-avatar.active {
      box-shadow: 0 0 0 3px #66b8ff, 0 2px 8px #8888;
    }
    .player-name {
      font-size: 1.1em;
      margin-bottom: 2px;
      text-align: center;
      letter-spacing: 1px;
    }
    .player-score {
      font-size: 2em;
      font-weight: bold;
      color: #222;
      margin-left: 8px;
      display: inline-block;
      vertical-align: middle;
    }
    #center-message {
      position: absolute;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      min-width: 400px;
      min-height: 50px;
      background: rgb(255, 255, 255);
      border-radius: 12px;
      box-shadow: 0 2px 12px #8888;
      font-size: 4em;
      font-weight: bold;
      color: #333;
      text-align: center;
      padding: 12px 24px;
      z-index: 9999;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.5s;
    }
    #center-message.show { opacity: 1; }
    #center-message.add { color: #27ae60; animation: pop 0.7s; }
    #center-message.sub { color: #e74c3c; animation: pop 0.7s; }
    #center-message.event { color: #f9ca24; animation: pop 0.7s; }
    @keyframes pop {
      0% { transform: translate(-50%,-50%) scale(0.7);}
      60% { transform: translate(-50%,-50%) scale(1.2);}
      100% { transform: translate(-50%,-50%) scale(1);}
    }
    #card-popup {
      position: fixed;
      left: 50%; top: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 3px solid #636e72;
      border-radius: 12px;
      box-shadow: 0 0 20px #888;
      padding: 30px 40px;
      z-index: 10000;
      display: none;
      min-width: 400px;
      text-align: center;
      font-family: "DFKai-SB", "æ¨™æ¥·é«”", DFKai-SB, serif;
      font-size: 2em;
    }
    #card-popup button {
      margin-top: 8px;
      font-size: 1em;
      padding: 4px 18px;
      border-radius: 8px;
      border: none;
      background: #636e72;
      color: #fff;
      cursor: pointer;
      font-family: "DFKai-SB", "æ¨™æ¥·é«”", DFKai-SB, serif;
    }
    @media (max-width: 900px) {
      #board-area { width: 99vw; }
      #board { min-width: 0; max-width: 99vw; }
      #bottom-bar { max-width: 99vw; }
    }
    @media (max-width: 600px) {
      #board { font-size: 0.7em; }
      .cell .emoji { font-size: 1em;}
      .player-avatar, .player-avatar-onboard { width: 1.5em; height: 1.5em;}
      #players-bar { min-width: 80px; max-width: 120px; padding: 4px 4px;}
      #bottom-bar { gap: 8px; }
    }
    #center-rect {
      grid-row: 2 / 5;
      grid-column: 2 / 12;
      background: url(https://raw.githubusercontent.com/lwkk0106/game-arts/main/xuanzhi.jpg);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      border: 2px solid #bbb;
      border-radius: 18px;
      box-shadow: 0 4px 24px #8888;
      opacity: 1;
      z-index: 100;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 100px;
      position: absolute;
      width: calc((100% / 12) * 10 - 4px);
      height: calc((100% / 5) * 3 - 4px);
      left: calc((100% / 12) * 1);
      top: calc((100% / 5) * 1);
      pointer-events: none;
    }
    #center-wheel {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      height: 100%;
      margin-bottom: 0;
      z-index: 22;
      pointer-events: auto;
      align-self: center;
    }
    #big-cards {
      display: flex;
      flex-direction: row;
      gap: 60px;
      justify-content: center;
      align-items: center;
      z-index: 9998;
      margin-top: 0;
      margin-left: 0;
      margin-bottom: 0;
      align-self: center;
    }
    .big-card {
      width: 120px;
      height: 170px;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 4px 16px #bbb8;
      border: 3px solid #636e72;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
      font-family: "DFKai-SB", "æ¨™æ¥·é«”", DFKai-SB, serif;
      cursor: pointer;
      position: relative;
      transition: transform 0.5s;
      user-select: none;
      pointer-events: none;
    }
    .big-card .card-back {      /* å¡èƒŒ */
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      font-weight: bold;
      background: url(https://raw.githubusercontent.com/lwkk0106/game-arts/main/chance.png);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      border-radius: 14px;
      position: absolute;
      top: 0; left: 0;
      backface-visibility: hidden;
      z-index: 2;
      box-sizing: border-box;
    }
    .big-card.fate .card-back {
      background: url(https://raw.githubusercontent.com/lwkk0106/game-arts/main/fate.png);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;    }
    .big-card .card-front {      /* æ­£é¢å¡ */
      display: none;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      font-weight: bold;
      color: #222;
      background: #ffffff;
      border-radius: 14px;
      position: absolute;
      top: 0; left: 0;
      z-index: 3;
      padding: 18px 8px;
      text-align: center;
      font-size: 1.1em;
      box-sizing: border-box;
    }
    .big-card.flipped .card-back {
      display: none;
    }
    .big-card.flipped .card-front {
      display: flex;
      animation: flipInNoScale 0.5s;
    }
    @keyframes flipInNoScale {
      0% { transform: rotateY(90deg); opacity: 0; }
      100% { transform: rotateY(0deg); opacity: 1; }
    }
  </style>
</head>
<body>
  <h1>å¤§å¯Œç¿éŠæˆ²</h1>
  <div id="main-row">
    <div id="board-area">
      <div id="board"></div>
      <div id="center-message"></div>
      <div id="center-rect">
        <div id="big-cards">
          <div class="big-card chance" id="big-chance-card" onclick="flipBigCard('chance')">
            <div class="card-back"></div>
            <div class="card-front"></div>
          </div>
          <div class="big-card fate" id="big-fate-card" onclick="flipBigCard('fate')">
            <div class="card-back"></div>
            <div class="card-front"></div>
          </div>
        </div>
        <div id="center-wheel">
          <div id="dice-container">
            <div class="dice" id="dice">
              <div class="dice-face face1"> <span class="dot"></span> </div>
              <div class="dice-face face2"> <span class="dot"></span><span class="dot"></span> </div>
              <div class="dice-face face3"> <span class="dot"></span><span class="dot"></span><span class="dot"></span> </div>
              <div class="dice-face face4"> <span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span> </div>
              <div class="dice-face face5"> <span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span> </div>
              <div class="dice-face face6"> <span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span><span class="dot"></span> </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="bottom-bar">
      <div id="players-bar"></div>
    </div>
  </div>
  <div id="card-popup">
    <div id="popup-content"></div>
  </div>
  <script>
    // æ£‹ç›¤æ ¼å­è³‡æ–™ï¼ˆ12x5å¤–åœˆï¼Œ30æ ¼ï¼‰
    const boardRows = 5, boardCols = 12, totalCells = 30;
    // æ ¼å­åˆ†å¸ƒ
    const cellTypes = [
      {type:'start', label:'èµ·é»', emoji:'ğŸš©'},
      {type:'question', label:'å•é¡Œ', emoji:'â“'},
      {type:'chance', label:'æ©Ÿæœƒ', emoji:'ğŸ€'},
      {type:'question', label:'å•é¡Œ', emoji:'â“'},
      {type:'normal', label:'æ™®é€š', emoji:'ğŸ“'},
      {type:'fate', label:'å‘½é‹', emoji:'ğŸ”®'},
      {type:'question', label:'å•é¡Œ', emoji:'â“'},
      {type:'go-jail', label:'é€®æ•', emoji:'ğŸš”'},
      {type:'question', label:'å•é¡Œ', emoji:'â“'},
      {type:'question', label:'å•é¡Œ', emoji:'â“'},
      {type:'normal', label:'æ™®é€š', emoji:'ğŸ“'},
      {type:'chance', label:'æ©Ÿæœƒ', emoji:'ğŸ€'},
      {type:'question', label:'å•é¡Œ', emoji:'â“'},
      {type:'fate', label:'å‘½é‹', emoji:'ğŸ”®'},
      {type:'question', label:'å•é¡Œ', emoji:'â“'},
      {type:'jail', label:'å¤©ç‰¢', emoji:'â›“ï¸'},
      {type:'question', label:'å•é¡Œ', emoji:'â“'},
      {type:'question', label:'å•é¡Œ', emoji:'â“'},
      {type:'normal', label:'æ™®é€š', emoji:'ğŸ“'},
      {type:'chance', label:'æ©Ÿæœƒ', emoji:'ğŸ€'},
      {type:'question', label:'å•é¡Œ', emoji:'â“'},
      {type:'fate', label:'å‘½é‹', emoji:'ğŸ”®'},
      {type:'question', label:'å•é¡Œ', emoji:'â“'},
      {type:'question', label:'å•é¡Œ', emoji:'â“'},
      {type:'normal', label:'æ™®é€š', emoji:'ğŸ“'},
      {type:'chance', label:'æ©Ÿæœƒ', emoji:'ğŸ€'},
      {type:'question', label:'å•é¡Œ', emoji:'â“'},
      {type:'fate', label:'å‘½é‹', emoji:'ğŸ”®'},
      {type:'question', label:'å•é¡Œ', emoji:'â“'},
      {type:'question', label:'å•é¡Œ', emoji:'â“'}
    ];
    const playerAvatars = [
      'https://raw.githubusercontent.com/lwkk0106/game-arts/main/player1.png', // ç©å®¶1é ­åƒ
      'https://raw.githubusercontent.com/lwkk0106/game-arts/main/player2.png', // ç©å®¶2é ­åƒ
      'https://raw.githubusercontent.com/lwkk0106/game-arts/main/player3.png', // ç©å®¶3é ­åƒ
      'https://raw.githubusercontent.com/lwkk0106/game-arts/main/player4.png'  // ç©å®¶4é ­åƒ
    ];
    const players = [
      { name: "ç©å®¶1", pos: 0, score: 0, inJail: false, skip: 0, avatar: playerAvatars[0] },
      { name: "ç©å®¶2", pos: 0, score: 0, inJail: false, skip: 0, avatar: playerAvatars[1] },
      { name: "ç©å®¶3", pos: 0, score: 0, inJail: false, skip: 0, avatar: playerAvatars[2] },
      { name: "ç©å®¶4", pos: 0, score: 0, inJail: false, skip: 0, avatar: playerAvatars[3] }
    ];
    let currentPlayer = 0;
    let gameOver = false;
    let extraTurn = false; // é¡å¤–å›åˆæ¨™è¨˜
    let isActionInProgress = false; // é˜²æ­¢é‡è¤‡æ“ä½œ

    // æ©Ÿæœƒå¡ã€å‘½é‹å¡
    const chanceCards = [
      { text: "å‰é€²2æ ¼", action: p => showCenterMessage("å‰é€²2æ ¼", "event") || movePlayer(p, 2) },
      { text: "ç²å¾—3åˆ†", action: p => { p.score += 3; showCenterMessage("ç²å¾—3åˆ†", "add"); } },
      { text: "èˆ‡éš¨æ©Ÿä¸€ä½ç©å®¶äº¤æ›ä½ç½®", action: p => {
        let candidates = players.filter((pl, idx) => idx !== currentPlayer);
        let randomIdx = Math.floor(Math.random() * candidates.length);
        let other = candidates[randomIdx];
        let tmp = p.pos;
        p.pos = other.pos;
        other.pos = tmp;
        showCenterMessage("èˆ‡éš¨æ©Ÿä¸€ä½ç©å®¶äº¤æ›ä½ç½®", "event");
      }},
      { text: "ç²å¾—å…ç‰¢é‡‘ç‰Œ", action: p => { 
        p.hasJailFree = true; 
        showCenterMessage("ç²å¾—å…ç‰¢é‡‘ç‰Œ", "add"); 
      }},
      { text: "å†æ“²ä¸€æ¬¡éª°å­", action: p => { 
        showCenterMessage("å†æ“²ä¸€æ¬¡éª°å­", "event"); 
        extraTurn = true; // æ¨™è¨˜ç‚ºé¡å¤–å›åˆ
      }},
      { text: "æ‰€æœ‰å…¶ä»–ç©å®¶å„å¤±å»2åˆ†", action: p => {
        players.forEach((player, i) => {
          if(i !== currentPlayer) {
            player.score = Math.max(0, player.score - 2);
          }
        });
        showCenterMessage("å…¶ä»–ç©å®¶å„å¤±å»2åˆ†", "sub");
      }},
      { text: "éš¨æ©Ÿå‰é€²ä»»æ„æ ¼æ•¸", action: p => {
        let steps = Math.floor(Math.random() * 6) + 1; // 1~6
        movePlayer(p, steps);
        showCenterMessage(`å‰é€²${steps}æ ¼`, "event");
      }},
      { text: "ç²å¾—3åˆ†", action: p => { p.score += 3; showCenterMessage("ç²å¾—3åˆ†", "add"); } },
      { text: "å‰é€²4æ ¼", action: p => showCenterMessage("å‰é€²4æ ¼", "event") || movePlayer(p, 4) },
      { text: "ç²å¾—å…ç‰¢é‡‘ç‰Œ", action: p => { 
        p.hasJailFree = true; 
        showCenterMessage("ç²å¾—å…ç‰¢é‡‘ç‰Œ", "add"); 
      }},
      { text: "èˆ‡æœ€ä½åˆ†ç©å®¶äº¤æ›åˆ†æ•¸", action: p => {
        let minScore = Math.min(...players.map(p => p.score));
        let minPlayer = players.find(p => p.score === minScore);
        if(minPlayer && minPlayer !== p) {
          [p.score, minPlayer.score] = [minPlayer.score, p.score];
          showCenterMessage("èˆ‡æœ€ä½åˆ†ç©å®¶äº¤æ›åˆ†æ•¸", "event");
        }
      }},
      { text: "å‰é€²3æ ¼", action: p => showCenterMessage("å‰é€²3æ ¼", "event") || movePlayer(p, 3) },
      { text: "ç²å¾—4åˆ†", action: p => { p.score += 4; showCenterMessage("ç²å¾—2åˆ†", "add"); } },
      { text: "å†æ“²ä¸€æ¬¡éª°å­", action: p => { 
        showCenterMessage("å†æ“²ä¸€æ¬¡éª°å­", "event"); 
        extraTurn = true; // æ¨™è¨˜ç‚ºé¡å¤–å›åˆ
      }},
      { text: "å‰é€²5æ ¼", action: p => showCenterMessage("å‰é€²5æ ¼", "event") || movePlayer(p, 5) }
    ];
    const fateCards = [
      { text: "å‰é€²3æ ¼", action: p => showCenterMessage("å‰é€²3æ ¼", "event") || movePlayer(p, 3) },
      { text: "å¤±å»3åˆ†", action: p => { p.score = Math.max(0, p.score - 3); showCenterMessage("å¤±å»3åˆ†", "sub"); } },
      { text: "ä¸‹å›åˆä¸èƒ½è¡Œå‹•", action: p => { setTimeout(()=>{ p.skip = 1; }, 10); showCenterMessage("ä¸‹å›åˆæš«åœä¸€æ¬¡", "event"); } },
      { text: "ä½œå¥¸çŠ¯ç§‘ï¼Œè¢«æ•", action: p => { 
        if(p.hasJailFree) {
          p.hasJailFree = false;
          showCenterMessage("ä½¿ç”¨å…ç‰¢é‡‘ç‰Œï¼Œå…é™¤ç‰¢ç„ä¹‹ç½ï¼", "add");
        } else {
          p.pos = findNextType(p.pos, 'go-jail'); 
          showCenterMessage("é‹ƒéºå…¥ç„", "event"); 
          setTimeout(()=>handleCell(p), 500); 
        }
      }},
      { text: "èˆ‡æœ€é«˜åˆ†ç©å®¶äº’æ›åˆ†æ•¸", action: p => {
        let maxScore = Math.max(...players.filter((pl, idx) => idx !== currentPlayer).map(pl => pl.score));
        let candidates = players.filter((pl, idx) => idx !== currentPlayer && pl.score === maxScore);
        let other = candidates[Math.floor(Math.random() * candidates.length)];
        if (other) {
          [p.score, other.score] = [other.score, p.score];
          showCenterMessage("èˆ‡æœ€é«˜åˆ†ç©å®¶äº’æ›åˆ†æ•¸", "event");
        } else {
          showCenterMessage("æ­å–œä½ ï¼Œä½ å·²ç¶“æ˜¯æœ€é«˜åˆ†äº†ï¼", "event");
        }
      }},
      { text: "é€€å›èµ·é»", action: p => { p.pos = 0; showCenterMessage("é€€å›èµ·é»", "event"); } },
      { text: "å¤±å»5åˆ†", action: p => { p.score = Math.max(0, p.score - 5); showCenterMessage("å¤±å»5åˆ†", "sub"); } },
      { text: "é€€å¾Œ2æ ¼", action: p => showCenterMessage("é€€å¾Œ2æ ¼", "event") || movePlayer(p, -2) },
      { text: "å¾—åˆ°5åˆ†", action: p => { p.score = Math.max(0, p.score += 5); showCenterMessage("å¤±å»2åˆ†", "sub"); } },
      { text: "ä¸‹å›åˆæš«åœ", action: p => { setTimeout(()=>{ p.skip = 1; }, 10); showCenterMessage("ä¸‹å›åˆæš«åœä¸€æ¬¡", "event"); } },
      { text: "å‰é€²4æ ¼", action: p => showCenterMessage("é€€å¾Œ4æ ¼", "event") || movePlayer(p, 4) },
      { text: "å¤±å»2åˆ†", action: p => { p.score = Math.max(0, p.score - 2); showCenterMessage("å¤±å»4åˆ†", "sub"); } },
      { text: "ä½œå¥¸çŠ¯ç§‘ï¼Œè¢«æ•", action: p => { 
        if(p.hasJailFree) {
          p.hasJailFree = false;
          showCenterMessage("ä½¿ç”¨å…ç‰¢é‡‘ç‰Œï¼Œå…é™¤ç‰¢ç„ä¹‹ç½ï¼", "add");
        } else {
          p.pos = findNextType(p.pos, 'go-jail'); 
          showCenterMessage("é‹ƒéºå…¥ç„", "event"); 
          setTimeout(()=>handleCell(p), 500); 
        }
      }},
      { text: "é€€å¾Œ1æ ¼", action: p => showCenterMessage("é€€å¾Œ1æ ¼", "event") || movePlayer(p, -1) },
      { text: "å¤±å»1åˆ†", action: p => { p.score = Math.max(0, p.score - 1); showCenterMessage("å¤±å»1åˆ†", "sub"); } }
    ];

    // ç‰Œå †æ©Ÿåˆ¶ï¼šæ¯æ¬¡æŠ½å¡ä¸é‡è¤‡ï¼ŒæŠ½å®Œæ‰é‡æ´—
    let chanceDeck = [];
    let fateDeck = [];
    function resetDecks() {
      chanceDeck = [...chanceCards];
      fateDeck = [...fateCards];
      shuffle(chanceDeck);
      shuffle(fateDeck);
    }
    resetDecks();

    // å•é¡Œå¡ï¼ˆ30é¡Œï¼Œæ¯é¡Œè‡ªè¨‚åŠ åˆ†ï¼‰
    const questionCards = [
      { q: "åœ°çƒæœ‰å¹¾å€‹å¤§æ´²ï¼Ÿ", pts: 2 },
      { q: "è«‹èªªå‡º3ç¨®æ°´æœ", pts: 1 },
      { q: "1+2+3+4ç­‰æ–¼å¤šå°‘ï¼Ÿ", pts: 2 },
      { q: "è«‹ç”¨30ç§’å…§èªªå‡º2ç¨®å‹•ç‰©", pts: 1 },
      { q: "å¤ªé™½å¾å“ªå€‹æ–¹å‘å‡èµ·ï¼Ÿ", pts: 2 },
      { q: "è«‹èªªå‡ºä¸€å€‹ç¯€æ—¥åç¨±", pts: 1 },
      { q: "æ°´çš„æ²¸é»æ˜¯å¤šå°‘åº¦Cï¼Ÿ", pts: 2 },
      { q: "è«‹èªªå‡ºä¸€å€‹ä¸­åœ‹çœä»½", pts: 1 },
      { q: "è«‹èªªå‡ºä¸€å€‹æ­æ´²åœ‹å®¶", pts: 1 },
      { q: "è«‹èªªå‡ºä¸€ç¨®äº¤é€šå·¥å…·", pts: 1 },
      { q: "è«‹èªªå‡ºä¸€ç¨®æ¨‚å™¨", pts: 1 },
      { q: "è«‹èªªå‡ºä¸€ç¨®é‹å‹•", pts: 1 },
      { q: "è«‹èªªå‡ºä¸€ç¨®è”¬èœ", pts: 1 },
      { q: "è«‹èªªå‡ºä¸€ç¨®é¡è‰²", pts: 1 },
      { q: "è«‹èªªå‡ºä¸€ç¨®å‹•ç‰©å«è²", pts: 2 },
      { q: "è«‹èªªå‡ºä¸€å€‹å¤©æ°£ç¾è±¡", pts: 1 },
      { q: "è«‹èªªå‡ºä¸€å€‹æ˜Ÿåº§", pts: 1 },
      { q: "è«‹èªªå‡ºä¸€å€‹è‹±æ–‡å–®è©", pts: 1 },
      { q: "è«‹èªªå‡ºä¸€å€‹æ•¸å­¸ç¬¦è™Ÿ", pts: 2 },
      { q: "è«‹èªªå‡ºä¸€å€‹æ­·å²äººç‰©", pts: 2 },
      { q: "è«‹èªªå‡ºä¸€å€‹ç§‘å­¸å®¶åå­—", pts: 2 },
      { q: "è«‹èªªå‡ºä¸€å€‹ç¯€æ°£åç¨±", pts: 2 },
      { q: "è«‹èªªå‡ºä¸€å€‹æˆèª", pts: 2 },
      { q: "è«‹èªªå‡ºä¸€å€‹å¤è©©è©", pts: 2 },
      { q: "è«‹èªªå‡ºä¸€å€‹é›»å½±åç¨±", pts: 1 },
      { q: "è«‹èªªå‡ºä¸€å€‹åŸå¸‚åç¨±", pts: 1 },
      { q: "è«‹èªªå‡ºä¸€å€‹åœ‹å®¶é¦–éƒ½", pts: 2 },
      { q: "è«‹èªªå‡ºä¸€å€‹è‘—åæ™¯é»", pts: 2 },
      { q: "è«‹èªªå‡ºä¸€å€‹ç¯€æ—¥ç¿’ä¿—", pts: 2 },
      { q: "è«‹èªªå‡ºä¸€å€‹ç«¥è©±æ•…äº‹åç¨±", pts: 1 }
    ];

    let allowSpin = true;

    // å–å¾—å¤–åœˆæ ¼å­ç´¢å¼•
    function getBoardPosList() {
      let posList = [];
      // ä¸Šé‚Š
      for(let i=0;i<boardCols;i++) posList.push(i);
      // å³é‚Š
      for(let i=1;i<boardRows-1;i++) posList.push(i*boardCols+boardCols-1);
      // ä¸‹é‚Š
      for(let i=boardCols-1;i>=0;i--) posList.push((boardRows-1)*boardCols+i);
      // å·¦é‚Š
      for(let i=boardRows-2;i>0;i--) posList.push(i*boardCols);
      // åªå–å‰30æ ¼
      return posList.slice(0,totalCells);
    }

    function createBoard() {
      const board = document.getElementById('board');
      board.innerHTML = '';
      // å…ˆå»ºç«‹5x12=60æ ¼
      for(let i=0;i<boardRows*boardCols;i++) {
        let cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.idx = -1;
        board.appendChild(cell);
      }
      // å°‡30æ ¼åˆ†é…åˆ°å¤–åœˆ
      let posList = getBoardPosList();
      for(let i=0;i<totalCells;i++) {
        let idx = posList[i];
        let cell = board.children[idx];
        cell.classList.add(cellTypes[i].type);
        cell.innerHTML = `<div class="emoji">${cellTypes[i].emoji}</div>
          <div class="cell-label">${cellTypes[i].label}</div>
          <div class="players"></div>`;
        cell.dataset.idx = i;
      }
      updateBoard();
    }

    // å¹³æ»‘æ£‹å­å‹•ç•«ç§»å‹•
    function updateBoard() {
      const board = document.getElementById('board');
      let posList = getBoardPosList();
      // æ¸…ç©ºæ‰€æœ‰æ ¼å­çš„ç©å®¶é ­åƒ
      for(let i=0;i<board.children.length;i++) {
        let cell = board.children[i];
        let playersDiv = cell.querySelector('.players');
        if(playersDiv) playersDiv.innerHTML = '';
      }
      // åœ¨æ­£ç¢ºæ ¼å­é¡¯ç¤ºç©å®¶é ­åƒ
      players.forEach((p, pi) => {
        let idx = posList[p.pos];
        let cell = board.children[idx];
        let playersDiv = cell.querySelector('.players');
        if(playersDiv) {
          let img = document.createElement('img');
          img.src = p.avatar;
          img.className = 'player-avatar-onboard';
          img.title = p.name;
          playersDiv.appendChild(img);
        }
      });
      updatePlayersBar();
    }

    // å‹•ç•«è·³æ ¼ç§»å‹•
    function animateMovePlayer(player, steps, callback) {
      let from = player.pos;
      let to = (player.pos + steps + totalCells) % totalCells;
      let path = [];
      let dir = steps > 0 ? 1 : -1;
      let n = Math.abs(steps);
      for(let i=1;i<=n;i++) {
        path.push((from + dir*i + totalCells) % totalCells);
      }
      let i = 0;
      function stepMove() {
        if(i < path.length) {
          player.pos = path[i];
          updateBoard();
          i++;
          setTimeout(stepMove, 180);
        } else {
          if(callback) callback();
        }
      }
      stepMove();
    }

    function updatePlayersBar() {
      let html = '';
      players.forEach((p, i) => {
        html += `<div class="player-card">
          <div class="player-avatar-info">
            <img class="player-avatar${currentPlayer===i?' active':''}" src="${p.avatar}" alt="avatar">
            <span class="player-name" style="cursor:pointer;text-decoration:underline;" onclick="editPlayerName(${i})">${p.name}</span>
          </div>
          <span class="player-score">${p.score}</span>
          ${p.hasJailFree ? '<span style="font-size: 1.2em; margin-left: 8px;" title="å…ç‰¢é‡‘ç‰Œ">ğŸ…</span>' : ''}
        </div>`;
      });
      document.getElementById('players-bar').innerHTML = html;
    }

    // æ–°å¢ï¼šå…è¨±ç©å®¶æ›´æ”¹åå­—
    window.editPlayerName = function(index) {
      const newName = prompt('è«‹è¼¸å…¥æ–°åå­—ï¼ˆæœ€å¤š8å­—ï¼‰', players[index].name);
      if(newName && newName.trim() && newName.length <= 8) {
        players[index].name = newName.trim();
        updatePlayersBar();
        updateBoard(); // è‹¥æ£‹ç›¤ä¸Šä¹Ÿæœ‰é¡¯ç¤ºåå­—å¯åŒæ­¥
      }
    }

    // 3Déª°å­å‹•ç•«
    const diceStyle = document.createElement('style');
    diceStyle.innerHTML = `
      #dice-container { width: 110px; height: 110px; perspective: 600px; margin: 0 auto 10px auto; cursor: pointer; user-select: none; }
      .dice { width: 100px; height: 100px; position: relative; transform-style: preserve-3d; transition: transform 1.2s cubic-bezier(.23,1.12,.67,1.01); }
      .dice.shake { animation: shakeDice 0.7s cubic-bezier(.36,.07,.19,.97) 1; }
      @keyframes shakeDice { 0% { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg); } 20% { transform: rotateX(60deg) rotateY(40deg) rotateZ(20deg); } 40% { transform: rotateX(-60deg) rotateY(-40deg) rotateZ(-20deg); } 60% { transform: rotateX(40deg) rotateY(60deg) rotateZ(10deg); } 80% { transform: rotateX(-40deg) rotateY(-60deg) rotateZ(-10deg); } 100% { transform: rotateX(0deg) rotateY(0deg) rotateZ(0deg); } }
      .dice-face { position: absolute; width: 100px; height: 100px; background: #fff; border: 2px solid #222; border-radius: 18px; box-shadow: 0 2px 8px #bbb8; display: flex; flex-wrap: wrap; align-items: center; justify-content: center; }
      .dot { width: 18px; height: 18px; background: #222; border-radius: 50%; margin: 8px; display: inline-block; }
      .face1 { transform: rotateY(0deg) translateZ(50px); }
      .face2 { transform: rotateY(180deg) translateZ(50px); }
      .face3 { transform: rotateY(90deg) translateZ(50px); }
      .face4 { transform: rotateY(-90deg) translateZ(50px); }
      .face5 { transform: rotateX(90deg) translateZ(50px); }
      .face6 { transform: rotateX(-90deg) translateZ(50px); }
    `;
    document.head.appendChild(diceStyle);

    // JSå‹•ç•«
    let allowRoll = true;
    const dice = document.getElementById('dice');
    const diceContainer = document.getElementById('dice-container');
    const diceRotations = [
      {x:0, y:0},      // 1
      {x:0, y:180},    // 2
      {x:0, y:-90},    // 3
      {x:0, y:90},     // 4
      {x:-90, y:0},    // 5
      {x:90, y:0}      // 6
    ];
    function rollDice() {
      if(!allowRoll || gameOver || isActionInProgress) return;
      
      // æª¢æŸ¥ç•¶å‰ç©å®¶æ˜¯å¦è¢«æš«åœ
      let p = players[currentPlayer];
      if(p.skip > 0) {
        showCenterMessage(`${p.name} æœ¬å›åˆæš«åœ`, "event");
        p.skip--;
        nextTurn();
        return;
      }
      
      isActionInProgress = true;
      allowRoll = false;
      dice.classList.add('shake');
      setTimeout(()=>{
        dice.classList.remove('shake');
        const result = Math.floor(Math.random()*6)+1;
        const rot = diceRotations[result-1];
        const extraX = 360*2 + rot.x;
        const extraY = 360*2 + rot.y;
        dice.style.transform = `rotateX(${extraX}deg) rotateY(${extraY}deg)`;
        setTimeout(()=>{
          playerMove(result);
          allowRoll = true;
          isActionInProgress = false;
        }, 1200);
      }, 700);
    }
    diceContainer.onclick = rollDice;

    // ç©å®¶ç§»å‹•
    function playerMove(steps) {
      let p = players[currentPlayer];
      if(p.inJail) {
        showCenterMessage(`${p.name} åœ¨å¤©ç‰¢ï¼Œç­”å°å•é¡Œæ‰èƒ½é›¢é–‹ã€‚`, "event");
        askQuestion(p, true);
        return;
      }
      movePlayer(p, steps, ()=>setTimeout(()=>handleCell(p), 200));
    }
    function movePlayer(player, steps, callback) {
      animateMovePlayer(player, steps, callback);
    }
    function findNextType(pos, type) {
      for(let i=1;i<totalCells;i++) {
        let idx = (pos+i)%totalCells;
        if(cellTypes[idx].type===type) return idx;
      }
      return pos;
    }
    function shuffle(arr) {
      for(let i=arr.length-1;i>0;i--) {
        let j = Math.floor(Math.random()*(i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    // æ ¼å­äº‹ä»¶
    function handleCell(p) {
      let cell = cellTypes[p.pos];
      switch(cell.type) {
        case 'start':
          showCenterMessage("ç¶“éèµ·é»ï¼Œ+5åˆ†", "add");
          p.score += 5;
          checkGameOver();
          nextTurn();
          break;
        case 'go-jail':
          if(p.hasJailFree) {
            p.hasJailFree = false;
            showCenterMessage("ä½¿ç”¨å…ç‰¢é‡‘ç‰Œï¼Œå…é™¤ç‰¢ç„ä¹‹ç½ï¼", "add");
            nextTurn();
          } else {
            showCenterMessage("é‹ƒéºå…¥ç„ï¼", "event");
            p.pos = findNextType(p.pos, 'jail');
            p.inJail = true;
            updateBoard();
            setTimeout(()=>handleCell(p), 500);
          }
          break;
        case 'jail':
          showCenterMessage("ç¶“éå¤©ç‰¢ï¼Œç„¡äº‹ç™¼ç”Ÿã€‚", "event");
          nextTurn();
          break;
        case 'question':
          askQuestion(p, false);
          break;
        case 'chance':
          drawCard(p, chanceDeck, "æ©Ÿæœƒå¡");
          break;
        case 'fate':
          drawCard(p, fateDeck, "å‘½é‹å¡");
          break;
        default:
          showCenterMessage("ç„¡äº‹ç™¼ç”Ÿ", "event");
          nextTurn();
      }
    }

    // å•é¡Œå¡
    function askQuestion(p, isJail) {
      shuffle(questionCards);
      let q = questionCards[0];
      showPopup(`<b>å•é¡Œå¡</b><br>${q.q}<br><span style='color:#0984e3;'>ï¼ˆç­”å°+${q.pts}åˆ†ï¼‰</span><br><button onclick='answerQ(true,${q.pts},${isJail})'>ç­”å°</button> <button onclick='answerQ(false,${q.pts},${isJail})'>ç­”éŒ¯</button>`);
    }
    window.answerQ = function(correct, pts, isJail) {
      closePopup();
      if(correct) {
        showCenterMessage(`ç­”å°äº†ï¼Œ+${pts}åˆ†`, "add");
        players[currentPlayer].score += pts;
        if(isJail) players[currentPlayer].inJail = false;
      } else {
        showCenterMessage("ç­”éŒ¯äº†ï¼Œç„¡åŠ åˆ†", "event");
      }
      checkGameOver();
      nextTurn();
    };

    // æ©Ÿæœƒ/å‘½é‹å¡
    function drawCard(p, deck, title) {
      if (deck.length === 0) {
        if (title === "æ©Ÿæœƒå¡") {
          chanceDeck = [...chanceCards];
          shuffle(chanceDeck);
          deck = chanceDeck;
        } else {
          fateDeck = [...fateCards];
          shuffle(fateDeck);
          deck = fateDeck;
        }
      }
      let card = deck.shift();
      showBigCard(title === 'æ©Ÿæœƒå¡' ? 'chance' : 'fate', card.text);
      allowSpin = false;
      setTimeout(() => {
        flipBigCard(title === 'æ©Ÿæœƒå¡' ? 'chance' : 'fate');
        setTimeout(() => {
          card.action(p);
          updateBoard();
          checkGameOver();
          setTimeout(nextTurn, 800);
        }, 1800);
      }, 1200);
    }

    // ä¸­å¤®è¨Šæ¯
    function showCenterMessage(msg, type) {
      const cm = document.getElementById('center-message');
      cm.textContent = msg;
      cm.className = 'show ' + (type||'');
      setTimeout(()=>{ cm.className = ''; }, 1500);
    }

    // å½ˆçª—
    function showPopup(html) {
      document.getElementById('popup-content').innerHTML = html;
      document.getElementById('card-popup').style.display = 'block';
    }
    function closePopup() {
      document.getElementById('card-popup').style.display = 'none';
    }
    window.closePopup = closePopup;

    // éŠæˆ²çµæŸåˆ¤æ–·
    function checkGameOver() {
      let winner = players.find(p=>p.score>=40);
      if(winner) {
        showCenterMessage(`éŠæˆ²çµæŸï¼Œå‹åˆ©è€…æ˜¯${winner.name}ï¼Œåˆ†æ•¸ï¼š${winner.score}`, "add");
        gameOver = true;
      }
    }

    // å›åˆåˆ‡æ›
    function nextTurn() {
      if(gameOver) return;
      if(extraTurn) {
        extraTurn = false;
        allowSpin = true;
        updateBoard(); // ä¿æŒç¾æœ‰ç©å®¶å…‰æšˆ
        return;
      }
      currentPlayer = (currentPlayer+1)%players.length;
      updateBoard(); // ç«‹åˆ»åˆ‡æ›å…‰æšˆ
      setTimeout(() => {
        allowSpin = true;
      }, 200);
    }

    // --- æ–°å¢ï¼šå¤§å¡èƒŒç¿»ç‰Œäº’å‹• ---
    function showBigCard(type, text) {
      document.getElementById('center-rect').style.pointerEvents = 'auto';
      const card = document.getElementById(type==='chance' ? 'big-chance-card' : 'big-fate-card');
      card.classList.remove('flipped');
      card.querySelector('.card-front').textContent = text || '';
      card.style.visibility = 'visible';
      card.style.pointerEvents = 'auto';
      // åªé¡¯ç¤ºå°æ‡‰å¡ï¼Œå¦ä¸€å¼µéš±è—
      document.getElementById('big-chance-card').style.visibility = 'visible';
      document.getElementById('big-fate-card').style.visibility = 'visible';
    }
    function flipBigCard(type) {
      const card = document.getElementById(type==='chance' ? 'big-chance-card' : 'big-fate-card');
      card.classList.add('flipped');
      setTimeout(()=>{
        // 5ç§’å¾Œè‡ªå‹•å¾©åŸç‚ºå¡èƒŒ
        card.classList.remove('flipped');
        card.style.visibility = 'visible';
        document.getElementById('center-rect').style.pointerEvents = 'none';
        allowSpin = true;
      }, 5000);
    }
    // --- ä¿®æ”¹ï¼šæ©Ÿæœƒ/å‘½é‹å¡äº‹ä»¶ ---

    // åˆå§‹åŒ–
    createBoard();
    updatePlayersBar();
    // åˆå§‹é¡¯ç¤ºå¤§å¡èƒŒ
    document.getElementById('big-chance-card').style.visibility = 'visible';
    document.getElementById('big-fate-card').style.visibility = 'visible';
    document.getElementById('center-rect').style.pointerEvents = 'none';
  </script>
</body>
</html>
